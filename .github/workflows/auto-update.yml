name: Update Ion Version

on:
    repository_dispatch:
        types: [build-docker-image]

permissions:
    contents: write

jobs:
    update-apkbuild:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  persist-credentials: false
            - name: Update APKBUILD
              run: |
                  VERSION="${{ github.event.client_payload.version }}"
                  PATCH="${{ github.event.client_payload.patch }}"
                  SHA512="${{ github.event.client_payload.sha512 }}"

                  # Strip leading 'v' from version and append patch for pkgver (e.g., 1.31.4.17)
                  PKGVER="${VERSION#v}.${PATCH}"

                  # Update pkgver in APKBUILD
                  sed -i "s/^pkgver=.*/pkgver=${PKGVER}/" src/northstar/APKBUILD

                  # Update sha512sums in APKBUILD
                  # Match the 128-character hex hash before the filename
                  sed -i -E "s/^[a-fA-F0-9]{128}(  Ion\.release\.v)/${SHA512}\1/" src/northstar/APKBUILD
            - name: Commit and push changes
              uses: GuillaumeFalourd/git-commit-push@v1.3
              with:
                  email: ${{ github.actor }}@users.noreply.github.com
                  name: ${{ github.actor }}
                  access_token: ${{ secrets.PUSH_TOKEN }}
                  files: src/northstar/APKBUILD
                  commit_message: "chore: update Ion to ${{ github.event.client_payload.version }} patch ${{ github.event.client_payload.patch }}"
